<div *ngIf="incident && currentSystem">
    <div [ngClass] = "{'d-none': !loading}">
    <hm-loader></hm-loader>
    </div>
    <div class="update-history">
        <mdb-card class="mb-4" *ngIf="incident.status == 'Completed' || incident.status == 'Resolved'">
            <div class="last-update-time"><strong>
                    <small>{{ incident.date_modified  | date: 'MMMM d, y' }}</small>
                </strong>
            </div>
            <div>
                <div class="update-status">{{ incident.status }}</div>
            </div>
            <div class="update-description">
                {{ incident.description }}
            </div>
            <div class="affected-systems">
                <span class="affected-systems-title"><small>Affected System : </small></span>
                <div class="system">
                    {{ incident.affected_system }} <mdb-icon fas icon="check-circle" class="green-text pr-3"></mdb-icon>
                </div>
            </div>
        </mdb-card>
        <div *ngIf="incident.incident_updates?.length">
            <mdb-card class="mb-4" *ngFor="let incident_update of incident.incident_updates">
                <div class="last-update-time">
                    <strong>
                        <small>{{ incident_update.date_created | date: 'MMMM d, y' }}</small>
                    </strong>
                </div>
                <div>
                    <div class="update-status">{{ incident_update.status }}</div>
                </div>
                <div class="update-description">
                    {{ incident_update.description }}
                </div>
                <div class="affected-systems">
                    <span class="affected-systems-title"><small>Affected System : </small></span>
                    <div class="system">
                        {{ incident.affected_system }} <mdb-icon fas icon="check-circle" class="green-text pr-3"></mdb-icon>
                    </div>
                </div>
            </mdb-card>
        </div>
    </div>
    <div class="new-update" *ngIf="incident.status !== 'Resolved' && incident.status !== 'Completed'">
        <div class="update-history-header">
            Add new update
        </div>
        <mdb-card class="grey lighten-5 update-form">
            <form [formGroup]="updateIncidentForm" (ngSubmit)="onSubmit()">
                <div class="row">
                    <div class="col">
                        <div class="form-group mb-4" *ngIf="incident.type === 'Realtime'">
                            <label class="form-label">Incident status</label>
                            <select formControlName="incidentStatus" class="browser-default custom-select"
                                [ngClass]="{'is-invalid': submitted && updateIncidentForm.controls.incidentStatus.errors}" [(ngModel)]="incident.state">
                                <option selected *ngFor = "let realtimeState of realtimeStates" value="{{realtimeState.id}}">
                                    {{realtimeState.name}}
                                </option>
                            </select>
                        </div>
                        <div class="form-group mb-4" *ngIf="incident.type === 'Scheduled'">
                            <label class="form-label">Maintenance status</label>
                            <select formControlName="incidentStatus" class="browser-default custom-select"
                                [ngClass]="{'is-invalid': submitted && updateIncidentForm.controls.incidentStatus.errors}">
                                <option selected *ngFor = "let scheduledState of scheduledStates" value="{{scheduledState.id}}" [(ngModel)]="incident.state">
                                    {{scheduledState.name}}
                                </option>
                            </select>
                        </div>
                    </div>
    
                    <div class="col form-group mb-4">
                        <label class="form-label" for="">Priority Level</label>
                        <select formControlName="priorityLevel"
                            [ngClass]="{ 'is-invalid': submitted && updateIncidentForm.controls.priorityLevel.errors }"
                            class="browser-default custom-select" [(ngModel)]="incident.priority_level">
                            <option selected value="1">Level 1</option>
                            <option value="2">Level 2</option>
                            <option value="3">Level 3</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5</option>
                        </select>
                    </div>
    
                    <div class="col mb-4">
                        <label class="form-label" for="">Assign user</label>
                        <select formControlName="user" [ngClass]="{ 'is-invalid': submitted && realtimeIncidentForm.controls.user.errors }" 
                        class="browser-default custom-select" [(ngModel)] = "incident.user">
                            <option selected [value]="user.id" *ngFor="let user of users">{{user.username}}</option>
                        </select>  
                    </div>
    
                    <div class="col mb-4">
                        <label class="form-label" for="">Escalation Level</label>
                        <select formControlName="escalationLevel" [ngClass]="{ 'is-invalid': submitted && realtimeIncidentForm.controls.escalationLevel.errors }" 
                        class="browser-default custom-select" [(ngModel)] = "incident.escalation_level">
                            <option selected [value]="level.id" *ngFor="let level of escalationLevels">{{level.name}}</option>
                        </select>
                    </div>                
                </div>
                <div class="form-group mb-4">
                    <label class="form-label">Message</label>
                    <textarea class="form-control rounded-2" formControlName="message"
                        id="exampleFormControlTextarea2" rows="3" placeholder="We are currently investigating this incident"
                        [ngClass]="{'is-invalid': submitted && updateIncidentForm.controls.message.errors}"
                        [(ngModel)]="incident.description">
                    </textarea>
    
                    <div *ngIf="updateIncidentForm.controls['message'].invalid && (updateIncidentForm.controls['message'].dirty || updateIncidentForm.controls['message'].touched)" class="invalid-feedback">
                        <div *ngIf="updateIncidentForm.controls['message'].errors.required">Message is required</div>
                    </div>
                </div>
                <div class="update-button">
                    <button mdbBtn [disabled]="updateIncidentForm.invalid"
                    mdbWavesEffect class="float-right"class="btn-sm blue-gradient lowercase-btn text-white float-right"> Update</button>
                </div>
            </form>
        </mdb-card>
    </div>
    <hr>
    <div class="delete-button">
        <button mdbBtn class="btn-sm lowercase-btn text-white float-right" color="danger" (click)="removeIncident(incidentId)">Delete Incident</button>
    </div>
</div>